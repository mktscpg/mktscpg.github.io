<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Drive SCMPG ‚Äì Gerenciador de Arquivos v3.3</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* ============================
           THEME & VARIABLES
        ============================ */
        :root {
            --bg-body: #0f172a;
            --bg-gradient: radial-gradient(circle at top center, #1e293b 0%, #0f172a 100%);
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-input: #0b1120;
            
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --border: 1px solid rgba(148, 163, 184, 0.15);
            --glass-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            --radius: 16px;
        }

        body { 
            margin: 0; 
            min-height: 100vh; 
            background: var(--bg-body); 
            background-image: var(--bg-gradient);
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .container { 
            width: 100%; 
            max-width: 1100px; 
        }

        /* ============================
           COMPONENTS
        ============================ */
        .card { 
            background: var(--bg-card); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 30px; 
            border-radius: var(--radius); 
            border: var(--border); 
            box-shadow: var(--glass-shadow); 
            margin-bottom: 30px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* HEADER & LOGO STYLES */
        header { 
            display: flex; 
            align-items: center; 
            gap: 25px; 
            margin-bottom: 40px; 
            padding: 25px; 
            background: rgba(30, 41, 59, 0.4);
            border: var(--border);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .logo-container {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
        }

        .logo-fallback {
            font-size: 38px;
            display: none; /* Shown by JS if image fails */
        }

        h1 { 
            font-size: 28px; 
            font-weight: 800; 
            letter-spacing: -0.5px; 
            margin: 0;
            line-height: 1.1;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h1 span { 
            font-weight: 400; 
            font-size: 0.55em; 
            color: var(--primary); 
            -webkit-text-fill-color: var(--primary); 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            display: block; 
            margin-top: 6px; 
        }

        @media (max-width: 600px) {
            header { flex-direction: column; text-align: center; gap: 15px; }
            h1 { font-size: 24px; }
        }

        h2 { 
            font-size: 15px; 
            margin: 0 0 20px 0; 
            color: var(--primary); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 700;
        }

        /* Buttons & Inputs */
        button { 
            width: 100%;
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        button:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
        button:active:not(:disabled) { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        button.secondary { background: var(--secondary); }
        button.outline { background: transparent; border: 1px solid var(--secondary); color: var(--text-muted); box-shadow: none; }
        button.outline:hover { border-color: var(--text-main); color: var(--text-main); }
        button.copy-btn { width: auto; padding: 6px 12px; font-size: 11px; margin-left: 10px; background: var(--bg-input); border: 1px solid var(--secondary); }

        input, select { 
            width: 100%; 
            padding: 14px; 
            border-radius: 10px; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: var(--bg-input); 
            color: white; 
            font-family: inherit;
            box-sizing: border-box; 
            outline: none;
            margin-bottom: 20px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        label { display: block; font-size: 11px; margin: 0 0 8px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }

        /* ============================
           INSTRUCTIONS TAB SYSTEM
        ============================ */
        details.instructions-panel {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border: var(--border);
            overflow: hidden;
            margin-bottom: 30px;
        }
        details.instructions-panel summary {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-main);
            background: rgba(255,255,255,0.02);
            list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            user-select: none;
        }
        details.instructions-panel summary::after { content: '+'; font-size: 18px; font-weight: 300; }
        details.instructions-panel[open] summary::after { content: '-'; }
        
        .tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { background: transparent; border-radius: 0; color: var(--text-muted); padding: 15px; width: auto; flex: 1; border-bottom: 2px solid transparent; box-shadow: none; }
        .tab-btn:hover { background: rgba(255,255,255,0.02); transform: none; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        
        .tab-content { padding: 25px; display: none; font-size: 14px; line-height: 1.6; color: var(--text-muted); }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tab-content strong { color: var(--text-main); }
        .tab-content code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; color: var(--warning); border: 1px solid rgba(255,255,255,0.05); }

        /* ============================
           GOOGLE AUTH UI
        ============================ */
        .auth-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; border: var(--border);
        }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 38px; height: 38px; border-radius: 50%; background: var(--secondary); object-fit: cover; border: 2px solid rgba(255,255,255,0.1); }
        .user-details div { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .user-details span { font-size: 12px; color: var(--text-muted); }
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.connected { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge.disconnected { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }

        /* Drive Browser */
        #driveBreadcrumb { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        #driveBreadcrumb a { color: var(--text-muted); text-decoration: none; font-size: 13px; padding: 4px 10px; border-radius: 6px; transition: 0.2s; background: rgba(255,255,255,0.02); }
        #driveBreadcrumb a:hover { background: rgba(255,255,255,0.08); color: var(--text-main); }
        #driveBreadcrumb a:last-child { color: var(--primary); font-weight: 600; pointer-events: none; background: rgba(59, 130, 246, 0.1); }

        #driveList { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        #driveList li { display: flex; align-items: center; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid rgba(255,255,255,0.02); }
        #driveList li:hover { background: rgba(255,255,255,0.05); }
        #driveList li .icon { font-size: 20px; margin-right: 15px; width: 24px; text-align: center; opacity: 0.8; }
        #driveList li .name { flex: 1; font-size: 14px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #driveList li:hover .name { color: var(--text-main); }

        /* ============================
           UPLOAD / DOWNLOAD UI
        ============================ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 850px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .tool-panel { background: rgba(15, 23, 42, 0.3); padding: 25px; border-radius: 12px; border: var(--border); display: flex; flex-direction: column; }
        .tool-panel h2 { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; }

        /* Progress Bar */
        .progress-container { margin-top: 25px; display: none; }
        .progress-track { background: rgba(255,255,255,0.05); height: 10px; border-radius: 99px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .progress-fill { background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; height: 100%; transition: width 0.3s ease; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .status-text { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 10px; display: flex; justify-content: space-between; }

        /* Result Box */
        .result-box { margin-top: 25px; padding: 20px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; display: none; animation: slideUp 0.3s ease; }
        .result-link { word-break: break-all; color: var(--success); font-size: 13px; font-family: 'JetBrains Mono', monospace; text-decoration: none; border-bottom: 1px dotted; transition: opacity 0.2s; }
        .result-link:hover { opacity: 0.8; }

        /* ============================
           TOAST NOTIFICATIONS
        ============================ */
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 12px; width: 90%; max-width: 420px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 14px 18px; border-radius: 10px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); font-size: 13px; border-left: 4px solid var(--primary); display: flex; align-items: center; justify-content: space-between; animation: slideUp 0.3s ease; pointer-events: auto; border: 1px solid rgba(255,255,255,0.05); }
        .toast.error { border-left-color: var(--danger); }
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo-container">
            <img src="icon.png" alt="SCMPG Icon" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div class="logo-fallback">üìÅ</div>
        </div>
        <div style="flex:1">
            <h1>DRIVE SCMPG <span>Gerenciador de Arquivos v3.3</span></h1>
        </div>
    </header>

    <details class="instructions-panel">
        <summary>‚ÑπÔ∏è Central de Ajuda e Instru√ß√µes</summary>
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'tab-intro')">In√≠cio</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-upload')">Upload</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-rebuild')">Baixar/Juntar</button>
        </div>

        <div id="tab-intro" class="tab-content active">
            <p><strong>Bem-vindo ao Gerenciador de Arquivos.</strong></p>
            <ul>
                <li>Use o <strong>Google Drive</strong> para navegar em arquivos internos da institui√ß√£o.</li>
                <li>Use o <strong>Painel de Envio</strong> para hospedar arquivos temporariamente (Catbox/Litterbox).</li>
                <li><strong>Corre√ß√£o v3.3:</strong> Sistema de upload unificado para prevenir erros de rede (CORS).</li>
            </ul>
        </div>

        <div id="tab-upload" class="tab-content">
            <p><strong>Limites de Upload:</strong></p>
            <ul>
                <li><strong>Permanente:</strong> M√°ximo 200MB.</li>
                <li><strong>Tempor√°rio (1h/24h/72h):</strong> M√°ximo 1GB.</li>
            </ul>
            <p>Para arquivos maiores que o limite, use a op√ß√£o <strong>Fragmenta√ß√£o Segura</strong> (apenas upload tempor√°rio).</p>
        </div>

        <div id="tab-rebuild" class="tab-content">
            <p><strong>Como reconstituir arquivos fragmentados:</strong></p>
            <ol>
                <li>Copie o link do arquivo <code>.json</code> que voc√™ recebeu.</li>
                <li>Cole no campo "URL do Manifesto" no painel √† direita.</li>
                <li>Clique em <strong>Baixar e Juntar</strong>.</li>
            </ol>
        </div>
    </details>

    <div class="card">
        <h2>
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
            Navegador Institucional (Google Drive)
        </h2>

        <div class="auth-bar">
            <div class="user-info" id="userInfo" style="display:none">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <div class="user-details">
                    <div id="userName">Usu√°rio</div>
                    <span id="userEmail">email@domain.com</span>
                </div>
                <span class="badge connected">Conectado</span>
            </div>
            <div class="user-info" id="loggedOutInfo">
                <span class="badge disconnected">Desconectado</span>
            </div>

            <div style="width: auto;">
                <button id="loginBtn" style="width: auto; padding: 10px 20px;">Login Google</button>
                <button id="logoutBtn" class="outline" style="display:none; width: auto; padding: 10px 20px;">Sair</button>
            </div>
        </div>

        <div id="driveUI" style="display:none">
            <div id="driveBreadcrumb"></div>
            <ul id="driveList"></ul>
        </div>
    </div>

    <div class="grid-2">
        <div class="tool-panel">
            <h2>
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                Upload P√∫blico
            </h2>
            
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label>Expira√ß√£o</label>
                    <select id="mode">
                        <option value="1h">1 Hora</option>
                        <option value="24h" selected>24 Horas</option>
                        <option value="72h">72 Horas</option>
                        <option value="none">Permanente (< 200MB)</option>
                    </select>
                </div>
            </div>

            <label>Selecione o Arquivo</label>
            <input id="fileInput" type="file">

            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <input type="checkbox" id="experimentalMode" style="width: 20px; margin: 0; cursor: pointer;">
                <div style="font-size: 12px; color: var(--text-muted); line-height: 1.3;">
                    <strong style="color: var(--text-main);">Fragmenta√ß√£o Segura</strong><br>
                    Use para arquivos maiores que o limite ou inst√°veis.
                </div>
            </div>

            <button id="submitBtn">Iniciar Upload</button>

            <div class="progress-container" id="uploadProgress">
                <div class="progress-track"><div id="pFill" class="progress-fill"></div></div>
                <div class="status-text">
                    <span id="uploadStatusText">Aguardando...</span>
                    <span id="uploadPercent">0%</span>
                </div>
            </div>

            <div id="resultBox" class="result-box">
                <label style="color: var(--success);">LINK GERADO:</label>
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                    <a id="downloadLink" class="result-link" href="#" target="_blank">...</a>
                    <button class="copy-btn" onclick="copyResult()">COPIAR</button>
                </div>
            </div>
        </div>

        <div class="tool-panel">
            <h2>
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Reconstituir (.json)
            </h2>
            
            <label>Cole a URL do Manifesto JSON</label>
            <input id="manifestURL" type="text" placeholder="https://files.catbox.moe/..." onfocus="this.select()">

            <button id="rebuildBtn" class="secondary">Baixar e Unir</button>

            <div class="progress-container" id="rebuildProgress">
                <div class="progress-track"><div id="pFillRebuild" class="progress-fill"></div></div>
                <div class="status-text">
                    <span id="rebuildStatusText">Iniciando...</span>
                    <span id="rebuildPercent">0%</span>
                </div>
            </div>
            
            <div style="margin-top: auto; padding-top: 20px;">
                 <p style="font-size: 12px; color: var(--text-muted); opacity: 0.7;">
                    <strong>Nota:</strong> Se o upload falhar, verifique se o arquivo respeita o limite do modo escolhido ou se voc√™ possui bloqueadores de an√∫ncio (AdBlock) ativos.
                 </p>
            </div>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 50px; font-size: 11px; color: var(--text-muted); opacity: 0.6;">
        SCMPG Gerenciador de Arquivos v3.3 &bull; <a href="privacy.html" style="color: inherit; text-decoration: none; border-bottom: 1px dotted;">Privacy Policy</a> &bull; Network Aware
    </div>

</div>

<div id="toast-container"></div>

<script>
/* ==========================================
   UTILS: TOASTS & TABS & NETWORK
   ========================================== */
function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${msg}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

window.addEventListener('offline', () => showToast("Voc√™ est√° offline. Uploads podem falhar.", 'error'));
window.addEventListener('online', () => showToast("Conex√£o restabelecida.", 'success'));

function openTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    evt.currentTarget.classList.add('active');
}

/* ==========================================
   PART A: ROBUST GOOGLE AUTH SYSTEM
   ========================================== */
const G_CLIENT_ID = "112023661632-auniih2b9q1ahdst0irac1rir6q3q7h1.apps.googleusercontent.com";
const G_ROOT_ID = "1AVMzzfOBwFOngzdZSnuzE9cNsBkpvDqh";

let gAccessToken = null;
let gTokenExpiry = 0;
let tokenClient;
let folderStack = [];

window.onload = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: G_CLIENT_ID,
        scope: "https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile",
        callback: (resp) => {
            if (resp.error) {
                showToast("Erro na autentica√ß√£o: " + resp.error, 'error');
                return;
            }
            gAccessToken = resp.access_token;
            gTokenExpiry = Date.now() + (resp.expires_in * 1000) - 60000; 
            showToast("Login realizado com sucesso!", 'success');
            onLoginSuccess();
        },
    });
    document.getElementById('mode').addEventListener('change', checkFragRequirement);
};

document.getElementById("loginBtn").onclick = () => { tokenClient.requestAccessToken(); };

document.getElementById("logoutBtn").onclick = () => {
    const token = gAccessToken;
    if (token) google.accounts.oauth2.revoke(token, () => { console.log('Token revoked'); });
    gAccessToken = null;
    gTokenExpiry = 0;
    folderStack = [];
    document.getElementById("userInfo").style.display = "none";
    document.getElementById("loggedOutInfo").style.display = "flex";
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("driveUI").style.display = "none";
    showToast("Desconectado.");
};

async function onLoginSuccess() {
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("loggedOutInfo").style.display = "none";
    try {
        const userRes = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
            headers: { Authorization: `Bearer ${gAccessToken}` }
        });
        const user = await userRes.json();
        document.getElementById("userName").textContent = user.name;
        document.getElementById("userAvatar").src = user.picture;
        document.getElementById("userInfo").style.display = "flex";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("driveUI").style.display = "block";
        folderStack = [{ id: G_ROOT_ID, name: "Root" }];
        loadFolder(G_ROOT_ID);
    } catch (e) {
        showToast("Erro ao carregar perfil.", 'error');
    }
}

function getValidToken() {
    if (gAccessToken && Date.now() < gTokenExpiry) return gAccessToken;
    showToast("Sess√£o expirada. Por favor, fa√ßa login novamente.", 'warning');
    tokenClient.requestAccessToken();
    return null;
}

async function loadFolder(folderId) {
    const token = getValidToken();
    if (!token) return;

    showToast("Carregando arquivos...");
    const q = encodeURIComponent(`'${folderId}' in parents and trashed=false`);
    
    try {
        const res = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,mimeType,webViewLink,iconLink,size)&orderBy=folder,name`,
            { headers: { Authorization: `Bearer ${token}` } }
        );
        if (!res.ok) throw new Error("API Error " + res.status);
        const data = await res.json();
        renderDriveList(data.files || []);
        renderBreadcrumb();
    } catch (e) {
        showToast("Erro ao ler pasta: " + e.message, 'error');
    }
}

function renderDriveList(files) {
    const list = document.getElementById("driveList");
    list.innerHTML = "";
    if (files.length === 0) list.innerHTML = "<li style='justify-content:center; color:var(--text-muted)'>Pasta vazia</li>";

    files.forEach(f => {
        const li = document.createElement("li");
        const isFolder = f.mimeType === "application/vnd.google-apps.folder";
        const icon = isFolder ? "üìÅ" : "üìÑ";
        li.innerHTML = `<span class="icon">${icon}</span><span class="name">${f.name}</span>`;
        if (isFolder) {
            li.onclick = () => {
                folderStack.push({ id: f.id, name: f.name });
                loadFolder(f.id);
            };
        } else {
            li.onclick = () => window.open(f.webViewLink, '_blank');
        }
        list.appendChild(li);
    });
}

function renderBreadcrumb() {
    const bc = document.getElementById("driveBreadcrumb");
    bc.innerHTML = folderStack.map((f, i) => 
        `<a href="#" onclick="navToBreadcrumb(${i}); return false;">${f.name}</a>`
    ).join(" / ");
}

window.navToBreadcrumb = (index) => {
    folderStack = folderStack.slice(0, index + 1);
    loadFolder(folderStack[index].id);
};

/* ==========================================
   PART B: UPLOAD LOGIC (FIXED)
   ========================================== */
const CHUNK_SIZE = 100 * 1024 * 1024; // 100MB
const getApi = m => m === 'none' ? 'https://catbox.moe/user/api.php' : 'https://litterbox.catbox.moe/resources/internals/api.php';

function checkFragRequirement() {
    const mode = document.getElementById('mode').value;
    const chk = document.getElementById('experimentalMode');
    if (mode === 'none') {
        chk.checked = false;
        chk.disabled = true;
    } else {
        chk.disabled = false;
    }
}

document.getElementById('submitBtn').onclick = async () => {
    if (!navigator.onLine) return showToast("Sem internet.", 'error');

    const file = document.getElementById('fileInput').files[0];
    if (!file) return showToast("Selecione um arquivo.", 'error');

    const mode = document.getElementById('mode').value;
    // SIZE SAFETY CHECK
    if (mode === 'none' && file.size > 209715200) { // 200MB in bytes
        return showToast("Erro: Modo Permanente aceita apenas arquivos < 200MB. Use 1h/24h.", 'error');
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    document.getElementById('resultBox').style.display = 'none';
    const pContainer = document.getElementById('uploadProgress');
    pContainer.style.display = 'block';
    const pFill = document.getElementById('pFill');
    const pText = document.getElementById('uploadStatusText');
    const pPercent = document.getElementById('uploadPercent');

    const updateProgress = (pct, msg) => {
        pFill.style.width = pct + '%';
        pPercent.textContent = Math.round(pct) + '%';
        if(msg) pText.textContent = msg;
    };

    try {
        const isFrag = document.getElementById('experimentalMode').checked;
        
        if (isFrag) {
            // FRAGMENTED UPLOAD (UNCHANGED)
            const totalParts = Math.ceil(file.size / CHUNK_SIZE);
            let chunksUrls = [];
            
            for (let i = 0; i < totalParts; i++) {
                updateProgress((i / totalParts) * 100, `Enviando parte ${i+1}/${totalParts}...`);
                
                const fd = new FormData();
                fd.append('reqtype', 'fileupload');
                fd.append('fileToUpload', file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE), `${file.name}.p${i+1}`);
                if (mode !== 'none') fd.append('time', mode);

                const res = await fetch(getApi(mode), { method: 'POST', body: fd });
                if (!res.ok) throw new Error("Erro HTTP " + res.status);
                const url = await res.text();
                if (!url.startsWith('http')) throw new Error('Resposta inv√°lida do servidor');
                
                chunksUrls.push(url.trim());
                await new Promise(r => setTimeout(r, 1500));
            }

            updateProgress(95, "Gerando manifesto...");
            const manifest = { filename: file.name, chunks: chunksUrls };
            const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            
            const fd = new FormData();
            fd.append('reqtype', 'fileupload');
            fd.append('fileToUpload', blob, `${file.name}.json`);
            if (mode !== 'none') fd.append('time', mode);

            const res = await fetch(getApi(mode), { method: 'POST', body: fd });
            const finalUrl = await res.text();
            showResult(finalUrl);
            
        } else {
            // NORMAL UPLOAD - SWITCHED TO FETCH FOR STABILITY
            // NOTE: fetch does not support progress bars natively, but it handles CORS/Network better.
            updateProgress(0, "Enviando...");
            
            const fd = new FormData();
            fd.append('reqtype', 'fileupload');
            fd.append('fileToUpload', file);
            if (mode !== 'none') fd.append('time', mode);

            // Using fetch instead of XHR to fix "Network Error"
            const res = await fetch(getApi(mode), { method: 'POST', body: fd });
            
            if (!res.ok) throw new Error("Erro HTTP " + res.status);
            const text = await res.text();
            
            if (text.startsWith('http')) {
                showResult(text);
            } else {
                throw new Error("O servidor recusou o arquivo (Poss√≠vel erro de tamanho ou formato).");
            }
        }

    } catch (e) {
        showToast("Falha: " + e.message, 'error');
        btn.disabled = false;
        pText.textContent = "Erro no envio.";
        // Reset progress bar to red
        pFill.style.background = 'var(--danger)';
    }
};

function showResult(url) {
    url = url.trim();
    const rb = document.getElementById('resultBox');
    const dl = document.getElementById('downloadLink');
    dl.href = url;
    dl.textContent = url;
    rb.style.display = 'block';
    
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').textContent = "Upload Conclu√≠do";
    setTimeout(() => { document.getElementById('submitBtn').textContent = "Iniciar Upload"; }, 3000);
    
    document.getElementById('pFill').style.width = '100%';
    document.getElementById('uploadPercent').textContent = "100%";
    document.getElementById('uploadStatusText').textContent = "Conclu√≠do!";
    showToast("Upload realizado com sucesso!", 'success');
}

window.copyResult = () => {
    const url = document.getElementById('downloadLink').href;
    navigator.clipboard.writeText(url).then(() => showToast("Link copiado!"));
};

/* ==========================================
   PART C: REBUILD LOGIC
   ========================================== */
document.getElementById('rebuildBtn').onclick = async () => {
    if (!navigator.onLine) return showToast("Sem internet.", 'error');

    const url = document.getElementById('manifestURL').value.trim();
    if (!url) return showToast("Cole a URL do .json", 'warning');

    const btn = document.getElementById('rebuildBtn');
    btn.disabled = true;
    
    const pContainer = document.getElementById('rebuildProgress');
    pContainer.style.display = 'block';
    const pFill = document.getElementById('pFillRebuild');
    const pText = document.getElementById('rebuildStatusText');
    const pPercent = document.getElementById('rebuildPercent');

    try {
        pText.textContent = "Baixando manifesto...";
        const mfRes = await fetch(url);
        if (!mfRes.ok) throw new Error("Manifesto n√£o acess√≠vel");
        const manifest = await mfRes.json();
        
        const chunks = [];
        const total = manifest.chunks.length;

        for (let i = 0; i < total; i++) {
            pText.textContent = `Baixando parte ${i+1}/${total}`;
            const pct = ((i) / total) * 100;
            pFill.style.width = pct + '%';
            pPercent.textContent = Math.round(pct) + '%';
            
            const cRes = await fetch(manifest.chunks[i]);
            chunks.push(await cRes.arrayBuffer());
        }

        pText.textContent = "Montando arquivo...";
        pFill.style.width = '100%';
        pPercent.textContent = '100%';
        
        const blob = new Blob(chunks, { type: 'application/octet-stream' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = manifest.filename || 'downloaded_file';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast("Download iniciado!", 'success');

    } catch (e) {
        showToast("Erro: " + e.message, 'error');
    } finally {
        btn.disabled = false;
    }
};
</script>
</body>
</html>
